<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Race IAT</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #0b1020;
      color: #e7eaf6;
      display: grid;
      place-items: center;
      height: 100vh;
    }
    .container {
      max-width: 900px;
      padding: 24px;
    }
    .stimulus {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
    }
    .stimulus img {
      max-height: 120px;
    }
    .labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .label {
      flex: 1;
      padding: 10px;
      background: #121935;
      border-radius: 8px;
      margin: 0 6px;
      text-align: center;
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .primary {
      background: #7aa2ff;
      color: #0b1020;
    }
    .ghost {
      background: #121935;
      color: #e7eaf6;
    }
    .progress {
      height: 10px;
      background: #121935;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }
    .bar {
      height: 100%;
      background: #7aa2ff;
      width: 0%;
    }
    .results {
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Race Implicit Association Test</h1>
    <div class="labels">
      <div class="label" id="leftLabel">—</div>
      <div class="label" id="rightLabel">—</div>
    </div>
    <div class="stimulus" id="stimulus">Press Space to begin</div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="controls">
      <button class="primary" id="startBtn">Start / Resume</button>
      <button class="ghost" id="pauseBtn">Pause</button>
      <button class="ghost" id="resetBtn">Reset</button>
      <button class="ghost" id="downloadRaw">Download Raw (.csv)</button>
      <button class="ghost" id="downloadSummary">Download Summary (.csv)</button>
    </div>
    <div class="results" id="results">No results yet.</div>
  </div>

  <script>
    const CONFIG = {
      categories: {
        leftFirst: {
          name: 'Black Faces',
          items: [
            { type: 'image', value: 'black1.JPG' },
            { type: 'image', value: 'main/black2.JPG' },
            { type: 'image', value: 'RIAT/black3.JPG' },
            { type: 'image', value: 'images/black4.JPG' },
            { type: 'image', value: 'images/black5.JPG' },
            { type: 'image', value: 'images/black6.JPG' }
          ]
        },
        rightFirst: {
          name: 'White Faces',
          items: [
            { type: 'image', value: 'images/white1.JPG' },
            { type: 'image', value: 'images/white2.JPG' },
            { type: 'image', value: 'images/white3.JPG' },
            { type: 'image', value: 'images/white4.JPG' },
            { type: 'image', value: 'images/white5.JPG' },
            { type: 'image', value: 'images/white6.JPG' }
          ]
        }
      },
      attributes: {
        leftFirst: {
          name: 'Bad',
          items: [
            { type: 'text', value: 'evil' },
            { type: 'text', value: 'agony' },
            { type: 'text', value: 'awful' },
            { type: 'text', value: 'nasty' },
            { type: 'text', value: 'terrible' },
            { type: 'text', value: 'horrible' },
            { type: 'text', value: 'failure' },
            { type: 'text', value: 'hurt' }
          ]
        },
        rightFirst: {
          name: 'Good',
          items: [
            { type: 'text', value: 'joy' },
            { type: 'text', value: 'happy' },
            { type: 'text', value: 'laughter' },
            { type: 'text', value: 'love' },
            { type: 'text', value: 'glorious' },
            { type: 'text', value: 'pleasure' },
            { type: 'text', value: 'peace' },
            { type: 'text', value: 'wonderful' }
          ]
        }
      },
      blocks: [
        { type: 'attribute', trials: 16, left: 'attributes.leftFirst', right: 'attributes.rightFirst' },
        { type: 'category', trials: 16, left: 'categories.leftFirst', right: 'categories.rightFirst' },
        { type: 'combinedA', trials: 32, left: ['categories.leftFirst','attributes.leftFirst'], right: ['categories.rightFirst','attributes.rightFirst'] },
        { type: 'category', trials: 16, left: 'categories.rightFirst', right: 'categories.leftFirst' },
        { type: 'combinedB', trials: 32, left: ['categories.rightFirst','attributes.leftFirst'], right: ['categories.leftFirst','attributes.rightFirst'] }
      ],
      errorPenalty: 600
    };

    const $ = sel => document.querySelector(sel);
    const sample = arr => arr[Math.floor(Math.random()*arr.length)];
    const shuffle = arr => arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
    const now = () => performance.now();
    const getByPath = (obj, path) => path.split('.').reduce((o,k)=>o[k], obj);

    let state = {
      blockIndex: -1,
      trialIndex: 0,
      running: false,
      currentStimulus: null,
      keymap: { left: 'E', right: 'I' },
      startTime: null,
      data: [],
      summary: {}
    };

    let pool = [];

    function labelsFor(block){
      const nameOf = ref => Array.isArray(ref) ? ref.map(r=>getByPath(CONFIG,r).name).join(' or ') : getByPath(CONFIG,ref).name;
      return {left: nameOf(block.left), right: nameOf(block.right)};
    }

    function buildStimulusPool(block){
      const makePool = (left,right) => {
        const L = Array.isArray(left) ? left.flatMap(p=>getByPath(CONFIG,p).items) : getByPath(CONFIG,left).items;
        const R = Array.isArray(right)? right.flatMap(p=>getByPath(CONFIG,p).items) : getByPath(CONFIG,right).items;
        const pairs = [];
        for(let i=0;i<block.trials;i++){
          const side = Math.random()<0.5?'left':'right';
          const item = side==='left'? sample(L) : sample(R);
          pairs.push({...item, side});
        }
        return shuffle(pairs);
      };
      return makePool(block.left, block.right);
    }

    function start(){
      if(state.blockIndex===-1){ nextBlock(); }
      state.running = true;
      nextTrial();
    }

    function pause(){ state.running=false; }
    function reset(){
      state = {...state, blockIndex:-1, trialIndex:0, running:false, data:[], summary:{} };
      $('#stimulus').textContent = 'Press Space to begin';
      $('#leftLabel').textContent = '—';
      $('#rightLabel').textContent = '—';
      $('#bar').style.width = '0%';
      $('#results').textContent = 'No results yet.';
    }

        function nextBlock(){
      state.blockIndex++;
      state.trialIndex = 0;
      if(state.blockIndex >= CONFIG.blocks.length){ finish(); return; }
      const block = CONFIG.blocks[state.blockIndex];
      pool = buildStimulusPool(block);
      const {left, right} = labelsFor(block);
      $('#leftLabel').textContent = left;
      $('#rightLabel').textContent = right;
      $('#stimulus').textContent = `Block ${state.blockIndex + 1} of ${CONFIG.blocks.length}`;
      updateProgress();
    }

    function nextTrial(){
      if(!state.running) return;
      const block = CONFIG.blocks[state.blockIndex];
      if(state.trialIndex >= block.trials){
        nextBlock();
        return;
      }
      const stim = pool[state.trialIndex];
      state.currentStimulus = stim;
      state.startTime = now();
      if(stim.type === 'text'){
        $('#stimulus').textContent = stim.value;
      } else if(stim.type === 'image'){
        $('#stimulus').innerHTML = `<img src="${stim.value}">`;
      }
      updateProgress();
    }

    function updateProgress(){
      const totalDone = state.data.length;
      const totalTrials = CONFIG.blocks.reduce((a,b)=>a+b.trials,0);
      const pct = totalTrials ? Math.min(100, (totalDone/totalTrials)*100) : 0;
      $('#bar').style.width = pct.toFixed(1)+'%';
    }

    function handleKey(e){
      const k = e.key.toUpperCase();
      if(k===' '){ if(!state.running) start(); e.preventDefault(); return; }
      if(!state.running || !state.currentStimulus) return;
      if(k!==state.keymap.left && k!==state.keymap.right) return;

      const sidePressed = (k===state.keymap.left)? 'left':'right';
      const correct = sidePressed === state.currentStimulus.side;
      const rt = now() - state.startTime;

      state.data.push({
        block: state.blockIndex+1,
        trial: state.trialIndex+1,
        stimulus: state.currentStimulus.value,
        correctSide: state.currentStimulus.side,
        response: sidePressed,
        correct,
        rt
      });

      state.trialIndex++;
      nextTrial();
    }

    function finish(){
      state.running = false;
      $('#stimulus').textContent = 'All blocks complete. Computing results…';
      computeScores();
    }

    function computeScores(){
      const penalty = CONFIG.errorPenalty;
      const trials = state.data.map(r => ({
        ...r,
        rtAdj: r.correct ? r.rt : r.rt + penalty
      }));

      const A = trials.filter(r => r.block === 3).map(r => r.rtAdj);
      const B = trials.filter(r => r.block === 5).map(r => r.rtAdj);

      const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
      const sd = arr => {
        const m = mean(arr);
        return Math.sqrt(arr.reduce((a,b)=>a+Math.pow(b-m,2),0)/(arr.length-1));
      };

      let D = null, direction = '';
      if(A.length > 2 && B.length > 2){
        const pooledSD = sd(A.concat(B));
        D = (mean(B) - mean(A)) / pooledSD;
        direction = D > 0 ? 'Faster when Black+Bad / White+Good were paired (stereotypical).' :
                            'Faster when Black+Good / White+Bad were paired (counter-stereotypical).';
      }

      state.summary = {
        D: D != null ? Number(D.toFixed(2)) : null,
        nA: A.length,
        nB: B.length,
        direction
      };

      if(D == null){
        $('#results').textContent = 'Not enough valid data to compute a score.';
      } else {
        const interp = interpretD(D);
        $('#results').innerHTML = `
          <div><strong>D-score:</strong> <span style="font-size:20px">${state.summary.D}</span></div>
          <div>${direction}</div>
          <div>Interpretation: <em>${interp.text}</em></div>
          <div style="margin-top:8px">(Positive D = stereotypical bias. Negative D = counter-stereotypical bias.)</div>
        `;
      }
    }

    function interpretD(D){
      const abs = Math.abs(D);
      if(abs < .15) return { text: 'No association' };
      if(abs < .35) return { text: 'Slight association' };
      if(abs < .65) return { text: 'Moderate association' };
      return { text: 'Strong association' };
    }

    function exportRawCSV(){
      const headers = ['block','trial','stimulus','correctSide','response','correct','rt'];
      const rows = state.data.map(r => headers.map(h => r[h] ?? ''));
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      download('race-iat-raw.csv', csv);
    }

    function exportSummaryCSV(){
      const h = ['D','n_congruent','n_incongruent','errorPenaltyMs'];
      const r = [state.summary.D, state.summary.nA, state.summary.nB, CONFIG.errorPenalty];
      const csv = [h.join(','), r.join(',')].join('\n');
      download('race-iat-summary.csv', csv);
    }

    function download(filename, content){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], {type:'text/csv'}));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    window.addEventListener('keydown', handleKey);
    $('#startBtn').addEventListener('click', () => { if(!state.running) start(); });
    $('#pauseBtn').addEventListener('click', pause);
    $('#resetBtn').addEventListener('click', reset);
    $('#downloadRaw').addEventListener('click', exportRawCSV);
    $('#downloadSummary').addEventListener('click', exportSummaryCSV);
  </script>
</body>
</html>





